name: Docker Deploy to AWS

on:
  push:
    branches: [ main ]
    paths: 
      - 'docker/**'
      - 'backend/**'
      - 'frontend/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'docker/**'
      - 'backend/**'
      - 'frontend/**'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Test Docker build
      run: |
        cd docker
        docker-compose build
        
        # ì´ë¯¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ë¹Œë“œë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸
        docker-compose config
        echo "âœ… Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"

  deploy:
    runs-on: ubuntu-latest
    # main ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤ì œ ë°°í¬
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
      continue-on-error: true
    
    - name: Set environment variables
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |

        echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> $GITHUB_ENV
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
        echo "YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}" >> $GITHUB_ENV
        echo "ELEVEN_ST_API_KEY=${{ secrets.ELEVEN_ST_API_KEY }}" >> $GITHUB_ENV
        echo "PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}" >> $GITHUB_ENV
        echo "PINECONE_ENVIRONMENT=${{ secrets.PINECONE_ENVIRONMENT }}" >> $GITHUB_ENV
        echo "PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }}" >> $GITHUB_ENV
        echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> $GITHUB_ENV
        echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> $GITHUB_ENV
        echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}" >> $GITHUB_ENV
        echo "JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}" >> $GITHUB_ENV
        echo "DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }}" >> $GITHUB_ENV
        echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> $GITHUB_ENV
        echo "LIVE_SERVER_IP=${{ secrets.LIVE_SERVER_IP }}" >> $GITHUB_ENV
        echo "EC2_SSH_KEY=${{ secrets.EC2_SSH_KEY }}" >> $GITHUB_ENV

    
    - name: Create SSH key file
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/aws_key.pem
        chmod 600 ~/.ssh/aws_key.pem
    
    - name: Build and test Docker images
      run: |
        cd docker
        
        # Docker Compose íŒŒì¼ ì¡´ì¬ í™•ì¸
        if [ ! -f "docker-compose.yml" ]; then
          echo "âŒ docker-compose.yml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          ls -la
          exit 1
        fi
        
        # PRì—ì„œëŠ” í™˜ê²½ë³€ìˆ˜ ì—†ì´ ì„¤ì • íŒŒì¼ë§Œ ê²€ì¦
        echo "ğŸ” Docker Compose ì„¤ì • íŒŒì¼ ê²€ì¦ ì¤‘..."
        docker compose config --quiet
        
        echo "âœ… Docker Compose ì„¤ì • ê²€ì¦ ì™„ë£Œ"
    
    - name: Deploy to AWS EC2
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        # EC2 ì¸ìŠ¤í„´ìŠ¤ì— Docker ê´€ë ¨ íŒŒì¼ë“¤ ë³µì‚¬
        echo "ğŸ“ íŒŒì¼ì„ ${{ secrets.LIVE_SERVER_IP }}ì— ë³µì‚¬í•©ë‹ˆë‹¤..."
        scp -i ~/.ssh/aws_key.pem -o StrictHostKeyChecking=no \
          docker-compose.yml \
          docker-compose.prod.yml \
          nginx.conf \
          ubuntu@${{ secrets.LIVE_SERVER_IP }}:/home/ubuntu/mozara/
        
        # EC2ì—ì„œ ë°°í¬ ì‹¤í–‰
        ssh -i ~/.ssh/aws_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.LIVE_SERVER_IP }} << EOF
          cd /home/ubuntu/mozara
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          export GEMINI_API_KEY="$GEMINI_API_KEY"
          export OPENAI_API_KEY="$OPENAI_API_KEY"
          export YOUTUBE_API_KEY="$YOUTUBE_API_KEY"
          export ELEVEN_ST_API_KEY="$ELEVEN_ST_API_KEY"
          export PINECONE_API_KEY="$PINECONE_API_KEY"
          export PINECONE_ENVIRONMENT="$PINECONE_ENVIRONMENT"
          export PINECONE_INDEX_NAME="$PINECONE_INDEX_NAME"
          export GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID"
          export GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET"
          export KAKAO_CLIENT_SECRET="$KAKAO_CLIENT_SECRET"
          export JWT_SECRET_KEY="$JWT_SECRET_KEY"
          
          # Docker ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v docker &> /dev/null; then
            echo "Docker ì„¤ì¹˜ ì¤‘..."
            sudo apt update
            sudo apt install -y docker.io docker-compose
            sudo usermod -aG docker ubuntu
            sudo systemctl start docker
            sudo systemctl enable docker
          fi
          
          # Docker Hub ë¡œê·¸ì¸ (ì„ íƒì‚¬í•­)
          if [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ] && [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | sudo docker login --username "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin || echo "Docker Hub ë¡œê·¸ì¸ ì‹¤íŒ¨, ê³„ì† ì§„í–‰..."
          else
            echo "âš ï¸ Docker Hub ìê²© ì¦ëª…ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ ë¹Œë“œë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤."
          fi
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          sudo docker compose -f docker-compose.prod.yml down --volumes --remove-orphans
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ (ìˆœì„œëŒ€ë¡œ)
          echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘..."
          echo "1ï¸âƒ£ MySQL ë°ì´í„°ë² ì´ìŠ¤ ì‹œì‘..."
          sudo docker compose -f docker-compose.prod.yml up -d mysql
          
          echo "â³ MySQL í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°..."
          timeout 60 bash -c 'until sudo docker compose -f docker-compose.prod.yml exec mysql mysqladmin ping -h localhost -u root -p1234 --silent; do sleep 2; done'
          
          echo "2ï¸âƒ£ Spring Boot ë°±ì—”ë“œ ì‹œì‘..."
          sudo docker compose -f docker-compose.prod.yml up -d springboot
          
          echo "3ï¸âƒ£ Python API ë°±ì—”ë“œ ì‹œì‘..."
          sudo docker compose -f docker-compose.prod.yml up -d python-api
          
          echo "4ï¸âƒ£ React í”„ë¡ íŠ¸ì—”ë“œ ì‹œì‘..."
          sudo docker compose -f docker-compose.prod.yml up -d frontend
          
          echo "5ï¸âƒ£ Nginx í”„ë¡ì‹œ ì‹œì‘..."
          sudo docker compose -f docker-compose.prod.yml up -d nginx
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          sleep 10
          sudo docker compose -f docker-compose.prod.yml ps
          
          echo "âœ… AWS ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ ì„œë¹„ìŠ¤ URL: https://mozaracare.duckdns.org"
        EOF
    
    - name: Health check
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        sleep 30
        curl -f http://${{ secrets.LIVE_SERVER_IP }}:8080/actuator/health || echo "Spring Boot health check failed"
        curl -f http://${{ secrets.LIVE_SERVER_IP }}:8000/ || echo "Python FastAPI health check failed"
        curl -f http://${{ secrets.LIVE_SERVER_IP }}:3000 || echo "Frontend health check failed"
        echo "ğŸŒ ìµœì¢… ì„œë¹„ìŠ¤ URL: https://mozaracare.duckdns.org"
    
    - name: Cleanup SSH key
      if: always()
      run: |
        rm -f ~/.ssh/aws_key.pem
