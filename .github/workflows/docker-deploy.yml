name: Docker Deploy to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Check for changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          db:
            - 'backend/db/**'
          springboot:
            - 'backend/springboot/**'
          python:
            - 'backend/python/**'
          frontend:
            - 'frontend/**'
    
    - name: Build and push MySQL DB image
      if: steps.changes.outputs.db == 'true'
      run: |
        echo "ðŸ”¨ DB ë³€ê²½ì‚¬í•­ ê°ì§€ - ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/mozara-db ./backend/db
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/mozara-db
    
    - name: Build and push Spring Boot image
      if: steps.changes.outputs.springboot == 'true'
      run: |
        echo "ðŸ”¨ Spring Boot ë³€ê²½ì‚¬í•­ ê°ì§€ - ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/mozara-springboot ./backend/springboot
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/mozara-springboot
    
    - name: Build and push Python API image
      if: steps.changes.outputs.python == 'true'
      run: |
        echo "ðŸ”¨ Python API ë³€ê²½ì‚¬í•­ ê°ì§€ - ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/mozara-python-api ./backend/python
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/mozara-python-api
    
    - name: Build and push Frontend image
      if: steps.changes.outputs.frontend == 'true'
      run: |
        echo "ðŸ”¨ Frontend ë³€ê²½ì‚¬í•­ ê°ì§€ - ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/mozara-frontend ./frontend
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/mozara-frontend
    
    - name: Deploy to AWS EC2
      uses: appleboy/ssh-action@master
      with:
        username: ubuntu
        host: ${{ secrets.LIVE_SERVER_IP }}
        key: ${{ secrets.EC2_SSH_KEY }}
        timeout: 30m
        command_timeout: 30m
        script: |
          # Docker ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v docker &> /dev/null; then
            echo "ðŸ”§ Docker ì„¤ì¹˜ ì¤‘..."
            sudo apt update
            sudo apt install -y docker.io
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -aG docker ubuntu
            echo "âœ… Docker ì„¤ì¹˜ ì™„ë£Œ"
          else
            echo "âœ… Docker ì´ë¯¸ ì„¤ì¹˜ë¨"
          fi
          
          # Swapfile ì„¤ì • (ë©”ëª¨ë¦¬ ë¶€ì¡± í•´ê²°)
          if [ ! -f /swapfile ]; then
            echo "ðŸ”§ Swapfile ìƒì„± ì¤‘..."
            sudo fallocate -l 2G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
            echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
            echo "âœ… Swapfile ìƒì„± ì™„ë£Œ (2GB)"
          else
            echo "âœ… Swapfile ì´ë¯¸ ì¡´ìž¬í•¨"
          fi
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          if [ "$(sudo docker ps -a -q -f name=mozara-mysql)" ]; then
            sudo docker rm -f mozara-mysql
          fi
          if [ "$(sudo docker ps -a -q -f name=mozara-springboot)" ]; then
            sudo docker rm -f mozara-springboot
          fi
          if [ "$(sudo docker ps -a -q -f name=mozara-python-api)" ]; then
            sudo docker rm -f mozara-python-api
          fi
          if [ "$(sudo docker ps -a -q -f name=mozara-frontend)" ]; then
            sudo docker rm -f mozara-frontend
          fi
          if [ "$(sudo docker ps -a -q -f name=mozara-nginx)" ]; then
            sudo docker rm -f mozara-nginx
          fi
          
          # ê¸°ì¡´ ì´ë¯¸ì§€ ì •ë¦¬
          if [ "$(sudo docker images -q ${{ secrets.DOCKERHUB_USERNAME }}/mozara-db)" ]; then
            sudo docker rmi -f ${{ secrets.DOCKERHUB_USERNAME }}/mozara-db
          fi
          if [ "$(sudo docker images -q ${{ secrets.DOCKERHUB_USERNAME }}/mozara-springboot)" ]; then
            sudo docker rmi -f ${{ secrets.DOCKERHUB_USERNAME }}/mozara-springboot
          fi
          if [ "$(sudo docker images -q ${{ secrets.DOCKERHUB_USERNAME }}/mozara-python-api)" ]; then
            sudo docker rmi -f ${{ secrets.DOCKERHUB_USERNAME }}/mozara-python-api
          fi
          if [ "$(sudo docker images -q ${{ secrets.DOCKERHUB_USERNAME }}/mozara-frontend)" ]; then
            sudo docker rmi -f ${{ secrets.DOCKERHUB_USERNAME }}/mozara-frontend
          fi
          
          # Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ pull
          sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/mozara-db
          sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/mozara-springboot
          sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/mozara-python-api
          sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/mozara-frontend
          
          # 1. MySQL ì‹œìž‘
          sudo docker run -d \
            --name mozara-mysql \
            -p 3306:3306 \
            -e MYSQL_ROOT_PASSWORD=1234 \
            -e MYSQL_DATABASE=mozara \
            -v mysql_data:/var/lib/mysql \
            --memory=512m \
            --cpus=0.5 \
            --restart unless-stopped \
            ${{ secrets.DOCKERHUB_USERNAME }}/mozara-db
          
          # MySQL ëŒ€ê¸° (ì´ˆê¸°í™” ì‹œê°„ ê³ ë ¤)
          echo "â³ MySQL ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘..."
          sleep 30
          
          # MySQL ìƒíƒœ í™•ì¸
          echo "ðŸ” MySQL ìƒíƒœ í™•ì¸..."
          sudo docker ps | grep mozara-mysql || echo "âŒ MySQL ì»¨í…Œì´ë„ˆ ë¬¸ì œ ë°œìƒ"
          sudo docker logs mozara-mysql --tail 10 || echo "MySQL ë¡œê·¸ í™•ì¸ ì‹¤íŒ¨"
          
          # 2. Spring Boot ì‹œìž‘
          sudo docker run -d \
            --name mozara-springboot \
            -p 8080:8080 \
            -e "SPRING_DATASOURCE_URL=jdbc:mysql://mozara-mysql:3306/mozara?useSSL=false&serverTimezone=UTC" \
            -e "SPRING_DATASOURCE_USERNAME=root" \
            -e "SPRING_DATASOURCE_PASSWORD=1234" \
            -e "AI_PYTHON_BASE_URL=http://mozara-python-api:8000" \
            -e "ELEVEN_ST_API_KEY=${{ secrets.ELEVEN_ST_API_KEY }}" \
            -e "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" \
            -e "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" \
            -e "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}" \
            --memory=256m \
            --cpus=0.3 \
            --restart unless-stopped \
            ${{ secrets.DOCKERHUB_USERNAME }}/mozara-springboot
          
          # Spring Boot ì‹œìž‘ ëŒ€ê¸°
          echo "â³ Spring Boot ì‹œìž‘ ëŒ€ê¸° ì¤‘..."
          sleep 15
          
          # 3. Python API ì‹œìž‘
          sudo docker run -d \
            --name mozara-python-api \
            -p 8000:8000 \
            -e GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }} \
            -e OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
            -e YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }} \
            -e ELEVEN_ST_API_KEY=${{ secrets.ELEVEN_ST_API_KEY }} \
            -e PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }} \
            -e PINECONE_ENVIRONMENT=${{ secrets.PINECONE_ENVIRONMENT }} \
            -e PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }} \
            --memory=128m \
            --cpus=0.2 \
            --restart unless-stopped \
            ${{ secrets.DOCKERHUB_USERNAME }}/mozara-python-api
          
          # 4. Frontend ì‹œìž‘
          sudo docker run -d \
            --name mozara-frontend \
            -p 3000:80 \
            --memory=64m \
            --cpus=0.1 \
            --restart unless-stopped \
            ${{ secrets.DOCKERHUB_USERNAME }}/mozara-frontend
          
          # Let's Encrypt ì¸ì¦ì„œ ë°œê¸‰
          if [ ! -d "/etc/letsencrypt/live/mozaracare.duckdns.org" ]; then
            echo "ðŸ” SSL ì¸ì¦ì„œ ë°œê¸‰ ì¤‘..."
            sudo apt update
            sudo apt install -y certbot
            sudo certbot certonly --standalone -d mozaracare.duckdns.org --non-interactive --agree-tos --email admin@mozaracare.duckdns.org
            echo "âœ… SSL ì¸ì¦ì„œ ë°œê¸‰ ì™„ë£Œ"
          else
            echo "âœ… SSL ì¸ì¦ì„œ ì´ë¯¸ ì¡´ìž¬í•¨"
          fi
          
          # Nginx ì„¤ì • íŒŒì¼ ìƒì„±
          sudo rm -rf /tmp/nginx.conf
          sudo tee /tmp/nginx.conf > /dev/null << 'EOF'
          server {
              listen 80;
              server_name mozaracare.duckdns.org 15.165.239.48;
              client_max_body_size 10m;
              
              # HTTP to HTTPS redirect
              return 301 https://$server_name$request_uri;
          }
          
          server {
              listen 443 ssl;
              http2 on;
              server_name mozaracare.duckdns.org 15.165.239.48;
              client_max_body_size 10m;
              
              # SSL ì¸ì¦ì„œ ì„¤ì • (Let's Encrypt)
              ssl_certificate /etc/letsencrypt/live/mozaracare.duckdns.org/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/mozaracare.duckdns.org/privkey.pem;
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
              ssl_prefer_server_ciphers off;
              
              location / {
                  proxy_pass http://mozara-frontend:80;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }
              
              location /api/ {
                  proxy_pass http://mozara-springboot:8080/api/;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }
              
              location /ws-game/ {
                  proxy_pass http://mozara-springboot:8080/ws-game/;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "Upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
              
              location /uploads/ {
                  proxy_pass http://mozara-springboot:8080/uploads/;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
          EOF
          
          # 5. Nginx í”„ë¡ì‹œ ì‹œìž‘
          sudo docker run -d \
            --name mozara-nginx \
            -p 80:80 \
            -p 443:443 \
            -v /tmp/nginx.conf:/etc/nginx/conf.d/default.conf:ro \
            -v /etc/letsencrypt:/etc/letsencrypt:ro \
            --memory=32m \
            --cpus=0.1 \
            --restart unless-stopped \
            --link mozara-frontend:mozara-frontend \
            --link mozara-springboot:mozara-springboot \
            nginx:alpine
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          sleep 5
          sudo docker ps
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          echo "ðŸŒ ì„œë¹„ìŠ¤ URL: http://${{ secrets.LIVE_SERVER_IP }}"