name: Docker Deploy to AWS

on:
  push:
    branches: [ main ]
    paths: 
      - 'docker/**'
      - 'backend/**'
      - 'frontend/**'
  # pull_request ë¹„í™œì„±í™” (main ë¸Œëœì¹˜ì—ì„œë§Œ deploy ì‹¤í–‰)
  # pull_request:
  #   branches: [ main ]
  #   paths:
  #     - 'docker/**'
  #     - 'backend/**'
  #     - 'frontend/**'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Test Docker build
      run: |
        cd docker
        docker-compose build
        
        # ì´ë¯¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ë¹Œë“œë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸
        docker-compose config
        echo "âœ… Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"

  deploy:
    runs-on: ubuntu-latest
    # main ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤ì œ ë°°í¬
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
      continue-on-error: true
    
    - name: Set environment variables
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        ELEVEN_ST_API_KEY: ${{ secrets.ELEVEN_ST_API_KEY }}
        PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
        PINECONE_ENVIRONMENT: ${{ secrets.PINECONE_ENVIRONMENT }}
        PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        LIVE_SERVER_IP: ${{ secrets.LIVE_SERVER_IP }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      run: |
        echo "í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ"
    
    - name: Create SSH key file
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/aws_key.pem
        chmod 600 ~/.ssh/aws_key.pem
    
    - name: Build and push Docker images
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        # Docker Hub ë¡œê·¸ì¸
        echo "$DOCKERHUB_TOKEN" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
        
        # Spring Boot ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        echo "ğŸ”¨ Spring Boot ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build -t $DOCKERHUB_USERNAME/mozara-springboot ./backend/springboot
        docker push $DOCKERHUB_USERNAME/mozara-springboot
        
        # Python API ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        echo "ğŸ”¨ Python API ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build -t $DOCKERHUB_USERNAME/mozara-python-api ./backend/python
        docker push $DOCKERHUB_USERNAME/mozara-python-api
        
        # Frontend ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        echo "ğŸ”¨ Frontend ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build -t $DOCKERHUB_USERNAME/mozara-frontend ./frontend
        docker push $DOCKERHUB_USERNAME/mozara-frontend
        
        echo "âœ… ëª¨ë“  Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ"
    
    - name: Deploy to AWS EC2
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        # EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì „ì²´ í”„ë¡œì íŠ¸ ë³µì‚¬
        echo "ğŸ“ í”„ë¡œì íŠ¸ë¥¼ ${{ secrets.LIVE_SERVER_IP }}ì— ë³µì‚¬í•©ë‹ˆë‹¤..."
        # LIVE_SERVER_IP ê°’ í™•ì¸ ë° ê²€ì¦
        echo "LIVE_SERVER_IP ê°’: '${{ secrets.LIVE_SERVER_IP }}'"
        echo "LIVE_SERVER_IP ê¸¸ì´: $(echo '${{ secrets.LIVE_SERVER_IP }}' | wc -c)"
        
        # LIVE_SERVER_IPê°€ ë¹„ì–´ìˆê±°ë‚˜ ì˜ëª»ëœ í˜•ì‹ì¸ì§€ í™•ì¸
        if [ -z "${{ secrets.LIVE_SERVER_IP }}" ]; then
          echo "âŒ LIVE_SERVER_IPê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        if [[ "${{ secrets.LIVE_SERVER_IP }}" == http* ]]; then
          echo "âŒ LIVE_SERVER_IPì— http:// ë˜ëŠ” https://ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤!"
          echo "ì˜¬ë°”ë¥¸ í˜•ì‹: your-domain.duckdns.org ë˜ëŠ” IPì£¼ì†Œ"
          exit 1
        fi
        
        # ì „ì²´ í”„ë¡œì íŠ¸ë¥¼ EC2ì— ë³µì‚¬ (í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰)
        rsync -avz --progress -e "ssh -i ~/.ssh/aws_key.pem -o StrictHostKeyChecking=no" \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='__pycache__' \
          --exclude='.env' \
          --exclude='build' \
          --exclude='dist' \
          ./ ubuntu@${{ secrets.LIVE_SERVER_IP }}:/home/ubuntu/mozara/
        
        # EC2ì—ì„œ ë°°í¬ ì‹¤í–‰
        ssh -i ~/.ssh/aws_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.LIVE_SERVER_IP }} << EOF
          cd /home/ubuntu/mozara/docker
          
          # .env íŒŒì¼ ìƒì„± (GitHub Secretsì—ì„œ ì§ì ‘ ì „ë‹¬)
          echo "GEMINI_API_KEY=$GEMINI_API_KEY" > .env
          echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> .env
          echo "YOUTUBE_API_KEY=$YOUTUBE_API_KEY" >> .env
          echo "ELEVEN_ST_API_KEY=$ELEVEN_ST_API_KEY" >> .env
          echo "PINECONE_API_KEY=$PINECONE_API_KEY" >> .env
          echo "PINECONE_ENVIRONMENT=$PINECONE_ENVIRONMENT" >> .env
          echo "PINECONE_INDEX_NAME=$PINECONE_INDEX_NAME" >> .env
          echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" >> .env
          echo "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" >> .env
          echo "KAKAO_CLIENT_SECRET=$KAKAO_CLIENT_SECRET" >> .env
          echo "DOCKERHUB_TOKEN=$DOCKERHUB_TOKEN" >> .env
          echo "DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME" >> .env
          
          # .env íŒŒì¼ ê¶Œí•œ ì„¤ì •
          chmod 644 .env
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          set -a
          source .env
          set +a
          
          # Docker ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v docker &> /dev/null; then
            echo "Docker ì„¤ì¹˜ ì¤‘..."
            sudo apt update
            sudo apt install -y docker.io
            sudo usermod -aG docker ubuntu
            sudo systemctl start docker
            sudo systemctl enable docker
          fi
          
          # Docker Compose ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v docker-compose &> /dev/null; then
            echo "Docker Compose ì„¤ì¹˜ ì¤‘..."
            sudo apt install -y docker-compose-plugin
            # ë˜ëŠ” standalone docker-compose ì„¤ì¹˜
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-\$(uname -s)-\$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # Docker Compose ë²„ì „ í™•ì¸
          echo "Docker Compose ë²„ì „ í™•ì¸:"
          docker compose version || docker-compose --version
          
          # Docker Hub ë¡œê·¸ì¸ (ì„ íƒì‚¬í•­)
          if [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ] && [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | sudo docker login --username "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin || echo "Docker Hub ë¡œê·¸ì¸ ì‹¤íŒ¨, ê³„ì† ì§„í–‰..."
          else
            echo "âš ï¸ Docker Hub ìê²© ì¦ëª…ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ ë¹Œë“œë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤."
          fi
          
          # Docker Compose ëª…ë ¹ì–´ ê²°ì •
          if command -v docker-compose &> /dev/null; then
            DOCKER_COMPOSE="docker-compose"
          else
            DOCKER_COMPOSE="docker compose"
          fi
          
          # Docker Compose íŒŒì¼ í™•ì¸
          echo "ğŸ“ Docker Compose íŒŒì¼ í™•ì¸ ì¤‘..."
          echo "âœ… Docker Compose íŒŒì¼ í™•ì¸:"
          grep -n "context:\|mozara.sql" docker-compose.prod.yml
          
          # í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ í™•ì¸
          echo "ğŸ” í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ í™•ì¸ ì¤‘..."
          echo "âœ… JWT_SECRET_KEYëŠ” application.propertiesì—ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤"
          
          # ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
          echo "ğŸ“ ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸:"
          ls -la ../
          ls -la ../backend/
          ls -la ../backend/springboot/
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          echo "ğŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
          if [ "$(sudo docker ps -a -q -f name=mozara-mysql-prod)" ]; then
            sudo docker rm -f mozara-mysql-prod
          fi
          if [ "$(sudo docker ps -a -q -f name=mozara-springboot-prod)" ]; then
            sudo docker rm -f mozara-springboot-prod
          fi
          if [ "$(sudo docker ps -a -q -f name=mozara-python-api-prod)" ]; then
            sudo docker rm -f mozara-python-api-prod
          fi
          if [ "$(sudo docker ps -a -q -f name=mozara-frontend-prod)" ]; then
            sudo docker rm -f mozara-frontend-prod
          fi
          if [ "$(sudo docker ps -a -q -f name=mozara-nginx-prod)" ]; then
            sudo docker rm -f mozara-nginx-prod
          fi
          
          # ê¸°ì¡´ ë³¼ë¥¨ ì •ë¦¬
          if [ "$(sudo docker volume ls -q -f name=mysql_prod_data)" ]; then
            sudo docker volume rm mysql_prod_data
          fi
          
          # ê¸°ì¡´ ì´ë¯¸ì§€ ì •ë¦¬
          if [ "$(sudo docker images -q $DOCKERHUB_USERNAME/mozara-springboot)" ]; then
            sudo docker rmi -f $DOCKERHUB_USERNAME/mozara-springboot
          fi
          if [ "$(sudo docker images -q $DOCKERHUB_USERNAME/mozara-python-api)" ]; then
            sudo docker rmi -f $DOCKERHUB_USERNAME/mozara-python-api
          fi
          if [ "$(sudo docker images -q $DOCKERHUB_USERNAME/mozara-frontend)" ]; then
            sudo docker rmi -f $DOCKERHUB_USERNAME/mozara-frontend
          fi
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ (ìˆœì„œëŒ€ë¡œ)
          echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘..."
          
          echo "1ï¸âƒ£ MySQL ë°ì´í„°ë² ì´ìŠ¤ ì‹œì‘..."
          sudo docker run -d \
            --name mozara-mysql-prod \
            -p 3306:3306 \
            -e MYSQL_ROOT_PASSWORD=1234 \
            -e MYSQL_DATABASE=mozara \
            -e MYSQL_USER=root \
            -e MYSQL_PASSWORD=1234 \
            -v mysql_prod_data:/var/lib/mysql \
            -v ./backend/springboot/db/mozara.sql:/docker-entrypoint-initdb.d/mozara.sql \
            --restart unless-stopped \
            mysql:8.0 --default-authentication-plugin=mysql_native_password
          
          echo "â³ MySQL ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°..."
          sleep 10
          
          # MySQL ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          if ! sudo docker ps | grep -q "mozara-mysql-prod"; then
            echo "âŒ MySQL ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¡œê·¸ í™•ì¸:"
            sudo docker logs mozara-mysql-prod
            exit 1
          fi
          echo "âœ… MySQL ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          echo "â³ MySQL í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°..."
          for i in {1..30}; do
            if sudo docker exec mozara-mysql-prod mysqladmin ping -h localhost -u root -p1234 --silent; then
              echo "âœ… MySQLì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤."
              break
            else
              echo "â³ MySQL ëŒ€ê¸° ì¤‘... ($i/30)"
              sleep 2
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ MySQL ì‹œì‘ ì‹¤íŒ¨. ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸:"
              sudo docker logs mozara-mysql-prod
              exit 1
            fi
          done
          
          echo "2ï¸âƒ£ Backend ì„œë¹„ìŠ¤ë“¤ ì‹œì‘..."
          
          echo "2-1ï¸âƒ£ Spring Boot ë°±ì—”ë“œ ì‹œì‘..."
          if [ "$(sudo docker images -q $DOCKERHUB_USERNAME/mozara-springboot)" ]; then
            sudo docker rmi -f $DOCKERHUB_USERNAME/mozara-springboot
          fi
          sudo docker pull $DOCKERHUB_USERNAME/mozara-springboot
          sudo docker run -d \
            --name mozara-springboot-prod \
            -p 8080:8080 \
            -e SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/mozara?useSSL=false&serverTimezone=UTC \
            -e SPRING_DATASOURCE_USERNAME=root \
            -e SPRING_DATASOURCE_PASSWORD=1234 \
            -e AI_PYTHON_BASE_URL=http://localhost:8000 \
            -e ELEVEN_ST_API_KEY=$ELEVEN_ST_API_KEY \
            -e GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID \
            -e GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET \
            -e KAKAO_CLIENT_SECRET=$KAKAO_CLIENT_SECRET \
            --restart unless-stopped \
            $DOCKERHUB_USERNAME/mozara-springboot
          
          echo "2-2ï¸âƒ£ Python API ë°±ì—”ë“œ ì‹œì‘..."
          if [ "$(sudo docker images -q $DOCKERHUB_USERNAME/mozara-python-api)" ]; then
            sudo docker rmi -f $DOCKERHUB_USERNAME/mozara-python-api
          fi
          sudo docker pull $DOCKERHUB_USERNAME/mozara-python-api
          sudo docker run -d \
            --name mozara-python-api-prod \
            -p 8000:8000 \
            -e GEMINI_API_KEY=$GEMINI_API_KEY \
            -e OPENAI_API_KEY=$OPENAI_API_KEY \
            -e YOUTUBE_API_KEY=$YOUTUBE_API_KEY \
            -e ELEVEN_ST_API_KEY=$ELEVEN_ST_API_KEY \
            -e PINECONE_API_KEY=$PINECONE_API_KEY \
            -e PINECONE_ENVIRONMENT=$PINECONE_ENVIRONMENT \
            -e PINECONE_INDEX_NAME=$PINECONE_INDEX_NAME \
            --restart unless-stopped \
            $DOCKERHUB_USERNAME/mozara-python-api
          
          echo "â³ Backend ì„œë¹„ìŠ¤ë“¤ ì‹œì‘ ëŒ€ê¸°..."
          sleep 10
          
          echo "3ï¸âƒ£ React í”„ë¡ íŠ¸ì—”ë“œ ì‹œì‘..."
          if [ "$(sudo docker images -q $DOCKERHUB_USERNAME/mozara-frontend)" ]; then
            sudo docker rmi -f $DOCKERHUB_USERNAME/mozara-frontend
          fi
          sudo docker pull $DOCKERHUB_USERNAME/mozara-frontend
          sudo docker run -d \
            --name mozara-frontend-prod \
            -p 3000:80 \
            --restart unless-stopped \
            $DOCKERHUB_USERNAME/mozara-frontend
          
          echo "4ï¸âƒ£ Nginx í”„ë¡ì‹œ ì‹œì‘..."
          # Nginx ì„¤ì • íŒŒì¼ ìƒì„±
          cat > nginx.conf << 'NGINX_EOF'
server {
    listen 80;
    server_name mozaracare.duckdns.org;

    client_max_body_size 10m;

    # Frontend í”„ë¡ì‹œ
    location / {
        proxy_pass http://172.17.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # API í”„ë¡ì‹œ
    location /api/ {
        proxy_pass http://172.17.0.1:8080/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    # WebSocket í”„ë¡ì‹œ
    location /ws-game/ {
        proxy_pass http://172.17.0.1:8080/ws-game/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
    
    # íŒŒì¼ ì—…ë¡œë“œ í”„ë¡ì‹œ
    location /uploads/{
        proxy_pass http://172.17.0.1:8080/uploads/;
    }
}
NGINX_EOF
          
          # Nginx ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          sudo docker run -d \
            --name mozara-nginx-prod \
            -p 80:80 \
            -v $(pwd)/nginx.conf:/etc/nginx/conf.d/default.conf:ro \
            --restart unless-stopped \
            nginx:alpine
          
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          sleep 10
          sudo docker ps
          
          echo "âœ… AWS ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ ì„œë¹„ìŠ¤ URL: https://mozaracare.duckdns.org"
        EOF
    
    - name: Health check
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      run: |
        # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        sleep 30
        curl -f http://${{ secrets.LIVE_SERVER_IP }}:8080/actuator/health || echo "Spring Boot health check failed"
        curl -f http://${{ secrets.LIVE_SERVER_IP }}:8000/ || echo "Python FastAPI health check failed"
        curl -f http://${{ secrets.LIVE_SERVER_IP }}:3000 || echo "Frontend health check failed"
        echo "ğŸŒ ìµœì¢… ì„œë¹„ìŠ¤ URL: https://mozaracare.duckdns.org"
    
    - name: Cleanup SSH key
      if: always()
      run: |
        rm -f ~/.ssh/aws_key.pem
