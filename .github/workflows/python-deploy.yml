name: Python API Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    # ì¡°ê±´: ìˆ˜ë™ ì‹¤í–‰ë˜ê±°ë‚˜, backend/python/ ê²½ë¡œ íŒŒì¼ì´ ìˆ˜ì •/ì¶”ê°€ë˜ê±°ë‚˜, ì»¤ë°‹ ë©”ì‹œì§€ì— 'python'ì´ í¬í•¨ë  ë•Œë§Œ ì‹¤í–‰
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.modified, 'backend/python/') || contains(github.event.head_commit.added, 'backend/python/') || contains(github.event.head_commit.message, 'python')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push Python API
        run: |
          echo "ğŸ”¨ Python API ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          # ì»¤ë°‹ SHAë¥¼ íƒœê·¸ë¡œ ì‚¬ìš©í•˜ì—¬ ëª…í™•í•œ ë²„ì „ ê´€ë¦¬
          COMMIT_SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_TAG_LATEST=${{ secrets.DOCKERHUB_USERNAME }}/mozara-python-api:latest
          IMAGE_TAG_VERSION=${{ secrets.DOCKERHUB_USERNAME }}/mozara-python-api:${COMMIT_SHA_SHORT}
          
          # ë‘ ê°€ì§€ íƒœê·¸ë¡œ ë¹Œë“œ ë° í‘¸ì‹œ
          docker build -t $IMAGE_TAG_LATEST -t $IMAGE_TAG_VERSION ./backend/python
          docker push $IMAGE_TAG_LATEST
          docker push $IMAGE_TAG_VERSION
          echo "âœ… Python API ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ"
  
  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy Python API to Runpod Pod
        run: |
          echo "ğŸš€ Runpod Podì— Python API ë°°í¬ ì¤‘..."
          
          # SSH í‚¤ ì„¤ì •
          mkdir -p ~/.ssh
          # RUNPOD_SSH_KEY ì‹œí¬ë¦¿ì„ ì‚¬ìš©í•˜ì—¬ í”„ë¼ì´ë¹— í‚¤ íŒŒì¼ ìƒì„±
          echo "${{ secrets.RUNPOD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Runpod SSH í˜¸ìŠ¤íŠ¸ í‚¤ë¥¼ known_hostsì— ì¶”ê°€í•˜ì—¬ ì—°ê²° ì‹œ ê²½ê³  ë°©ì§€
          ssh-keyscan -H ssh.runpod.io >> ~/.ssh/known_hosts
          
          # Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ëª…ë ¹ (ê°€ì¥ ìµœì‹  'latest' íƒœê·¸ ì‚¬ìš©)
          IMAGE_TAG=${{ secrets.DOCKERHUB_USERNAME }}/mozara-python-api:latest
          
          # ssh -T: PTY í• ë‹¹ ìš”ì²­ ì•ˆ í•¨ (Error: Your SSH client doesn't support PTY ë°©ì§€)
          # -o StrictHostKeyChecking=no: ì•Œë ¤ì§„ í˜¸ìŠ¤íŠ¸ í™•ì¸ì„ ê±´ë„ˆë›°ì–´ CI/CD í™˜ê²½ì—ì„œ ì˜¤ë¥˜ ë°©ì§€
          ssh -T -o StrictHostKeyChecking=no ${{ secrets.RUNPOD_POD_ID }}-6441140b@ssh.runpod.io '
            echo "ğŸ³ ê¸°ì¡´ Docker ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..." && 
            docker stop mozara-python || true && 
            docker rm mozara-python || true && 
            echo "ğŸ“¥ Docker ì´ë¯¸ì§€ pull ì¤‘..." && 
            docker pull '$IMAGE_TAG' && 
            echo "ğŸš€ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..." && 
            # -d: ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰, --name: ì»¨í…Œì´ë„ˆ ì´ë¦„ ì§€ì •, -p: í¬íŠ¸ í¬ì›Œë”©
            docker run -d --name mozara-python -p 8000:8000 '$IMAGE_TAG' && 
            echo "âœ… Python ì„œë²„ ë°°í¬ ì™„ë£Œ!"
          '
          
          echo "ğŸ‰ Python API ë°°í¬ ì™„ë£Œ!"